<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>OpenClaw Pages</title>
  <meta name="description" content="문서/정리 HTML 모음. 공유할 때는 이 사이트의 URL만 보내면 됨." />
  <style>
    :root { --fg:#1f2937; --muted:#64748b; --bg:#f8fafc; --card:#ffffff; --border:#e2e8f0; --link:#2563eb; --star:#f59e0b; }
    html,body { margin:0; padding:0; background:var(--bg); color:var(--fg); font-family:-apple-system,BlinkMacSystemFont,"Apple SD Gothic Neo","Noto Sans KR",Segoe UI,Roboto,Arial,sans-serif; line-height:1.55; }
    main { max-width: 980px; margin: 24px auto; padding: 0 16px; }
    a { color:var(--link); text-decoration:none; }
    a:hover { text-decoration:underline; }
    header { display:flex; justify-content:space-between; gap:16px; align-items:flex-start; }
    h1 { margin:0 0 6px; font-size: 22px; }
    .sub { margin:0; color:var(--muted); }
    .toolbar { display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin-top: 14px; }
    .pill.icon { display:flex; align-items:center; gap:8px; }
    .starBtn { border:0; background:transparent; cursor:pointer; padding:4px 6px; border-radius:8px; }
    .starBtn:hover { background:#f1f5f9; }
    .starBtn[aria-pressed="true"] { color: var(--star); }
    .cardTop { display:flex; align-items:flex-start; justify-content:space-between; gap:10px; }
    .input { border:1px solid var(--border); border-radius:10px; padding:10px 12px; min-width:260px; font-size:0.95rem; background:#fff; }
    .pill { border:1px solid var(--border); background:#fff; padding:6px 10px; border-radius:999px; font-size:0.9rem; cursor:pointer; }
    .pill[aria-pressed="true"] { border-color:#93c5fd; background:#eff6ff; }
    .grid { display:grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap:14px; margin-top:14px; }
    .card { border:1px solid var(--border); border-radius:12px; padding:14px 16px; background:var(--card); }
    .card h2 { margin:0 0 6px; font-size:1.05rem; }
    .card p { margin:0 0 10px; color:var(--muted); }
    .meta { color:var(--muted); font-size: 13px; }
    .sr-only { position:absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); white-space:nowrap; border:0; }
  </style>
</head>
<body>
  <main>
    <header>
      <div>
        <h1 id="siteTitle">OpenClaw Pages</h1>
        <p class="sub" id="siteSubtitle">문서/정리 HTML 모음. 공유할 때는 이 사이트의 URL만 보내면 됨.</p>
      </div>
      <div class="meta" style="text-align:right;">
        <div>repo: <a id="repoLink" href="https://github.com/samdasuu/openclaw-pages">https://github.com/samdasuu/openclaw-pages</a></div>
        <div class="sub">base: <a id="baseLink" href="./">https://samdasuu.github.io/openclaw-pages/</a></div>
      </div>
    </header>

    <div class="toolbar">
      <input class="input" id="q" placeholder="검색 (제목/요약/카테고리)" />
      <button class="pill icon" id="favToggle" aria-pressed="false" title="즐겨찾기만 보기">
        <span aria-hidden="true">★</span>
        <span>즐겨찾기</span>
      </button>
      <button class="pill" id="favSync" title="즐겨찾기 동기화(깃 저장) 설정">동기화</button>
      <div id="catBar" style="display:flex; gap:8px; flex-wrap:wrap;"></div>
    </div>

    <div id="status" class="meta" style="margin-top:10px;"></div>
    <div class="grid" id="grid"></div>

    <script>
      async function boot() {
        const res = await fetch('./pages.json', {cache:'no-store'});
        const data = await res.json();
        const pages = data.pages || [];

        const q = document.getElementById('q');
        const grid = document.getElementById('grid');
        const status = document.getElementById('status');
        const catBar = document.getElementById('catBar');
        const favToggle = document.getElementById('favToggle');

        // Favorites sync:
        // - default: localStorage
        // - optional: GitHub repo file favorites.json (requires a GitHub Fine-grained PAT)
        const FAV_KEY = 'openclaw_pages_favorites_v1';
        const GH_TOKEN_KEY = 'openclaw_pages_github_token_v1';
        const GH_OWNER = 'samdasuu';
        const GH_REPO = 'openclaw-pages';
        const GH_PATH = 'favorites.json';

        const readLocalFavs = () => {
          try { return new Set(JSON.parse(localStorage.getItem(FAV_KEY) || '[]')); }
          catch { return new Set(); }
        };
        const writeLocalFavs = (set) => {
          localStorage.setItem(FAV_KEY, JSON.stringify(Array.from(set)));
        };
        const getToken = () => localStorage.getItem(GH_TOKEN_KEY) || '';

        async function loadRepoFavs() {
          // Try GitHub Pages-served favorites.json first (no auth). Fallback to local.
          try {
            const r = await fetch('./favorites.json', { cache: 'no-store' });
            if (!r.ok) throw new Error('favorites.json not found');
            const arr = await r.json();
            if (!Array.isArray(arr)) throw new Error('invalid favorites.json');
            return new Set(arr);
          } catch {
            return readLocalFavs();
          }
        }

        async function saveRepoFavs(set) {
          const token = getToken();
          if (!token) {
            // No token → local only
            writeLocalFavs(set);
            return { ok: true, mode: 'local' };
          }

          // Update in GitHub repo via Contents API
          const api = `https://api.github.com/repos/${GH_OWNER}/${GH_REPO}/contents/${GH_PATH}`;

          const headers = {
            'Accept': 'application/vnd.github+json',
            'Authorization': `Bearer ${token}`
          };

          // 1) read current sha
          const getRes = await fetch(api, { headers });
          if (!getRes.ok) {
            // token invalid or permission issue
            writeLocalFavs(set);
            return { ok: false, mode: 'local', error: `GitHub GET failed: ${getRes.status}` };
          }
          const current = await getRes.json();
          const sha = current.sha;

          // 2) PUT new content
          const body = {
            message: 'Update favorites',
            content: btoa(unescape(encodeURIComponent(JSON.stringify(Array.from(set), null, 0) + '\n'))),
            sha
          };
          const putRes = await fetch(api, { method: 'PUT', headers: { ...headers, 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
          if (!putRes.ok) {
            writeLocalFavs(set);
            return { ok: false, mode: 'local', error: `GitHub PUT failed: ${putRes.status}` };
          }

          // Keep local as cache too
          writeLocalFavs(set);
          return { ok: true, mode: 'git' };
        }

        const cats = Array.from(new Set(pages.map(p => p.category).filter(Boolean)));
        const state = { cat: 'ALL', q: '', favOnly: false, favs: await loadRepoFavs() };

        function mkPill(label, value) {
          const b = document.createElement('button');
          b.className = 'pill';
          b.textContent = label;
          b.dataset.value = value;
          b.setAttribute('aria-pressed', value === state.cat ? 'true' : 'false');
          b.onclick = () => {
            state.cat = value;
            render();
            for (const el of catBar.querySelectorAll('button')) {
              el.setAttribute('aria-pressed', el.dataset.value === state.cat ? 'true' : 'false');
            }
          };
          return b;
        }

        catBar.appendChild(mkPill('ALL', 'ALL'));
        for (const c of cats) catBar.appendChild(mkPill(c, c));

        q.oninput = () => { state.q = q.value.trim().toLowerCase(); render(); };

        favToggle.onclick = () => {
          state.favOnly = !state.favOnly;
          favToggle.setAttribute('aria-pressed', state.favOnly ? 'true' : 'false');
          render();
        };

        document.getElementById('favSync').onclick = async () => {
          const cur = getToken() ? '설정됨' : '미설정';
          const token = prompt(
            `GitHub에 즐겨찾기를 저장하면 기기 간 동기화가 됩니다.\n\n` +
            `현재 토큰: ${cur}\n\n` +
            `Fine-grained PAT 권장 (repo: samdasuu/openclaw-pages, Contents read/write).\n` +
            `토큰을 입력(또는 빈 값으로 삭제)하세요.`
          );
          if (token === null) return;
          const t = token.trim();
          if (!t) localStorage.removeItem(GH_TOKEN_KEY);
          else localStorage.setItem(GH_TOKEN_KEY, t);
          alert('저장했습니다. 이제 즐겨찾기 변경 시 GitHub에 커밋됩니다.');
        };

        function render() {
          grid.innerHTML = '';
          let filtered = pages;
          if (state.cat !== 'ALL') filtered = filtered.filter(p => p.category === state.cat);
          if (state.favOnly) filtered = filtered.filter(p => state.favs.has(p.href));
          if (state.q) {
            filtered = filtered.filter(p => {
              const hay = `${p.title||''} ${p.description||''} ${p.category||''} ${p.date||''} ${p.id||''}`.toLowerCase();
              return hay.includes(state.q);
            });
          }
          const favCount = state.favs.size;
          status.textContent = `${filtered.length} / ${pages.length} 보고서 · 즐겨찾기 ${favCount}개`;

          for (const p of filtered) {
            const card = document.createElement('div');
            card.className = 'card';

            const top = document.createElement('div');
            top.className = 'cardTop';

            const h2 = document.createElement('h2');
            const a = document.createElement('a');
            a.href = `./${p.href}`;
            a.textContent = p.title;
            h2.appendChild(a);

            const star = document.createElement('button');
            star.className = 'starBtn';
            star.setAttribute('aria-pressed', state.favs.has(p.href) ? 'true' : 'false');
            star.title = state.favs.has(p.href) ? '즐겨찾기 해제' : '즐겨찾기 추가';
            star.innerHTML = '<span aria-hidden="true">★</span><span class="sr-only">즐겨찾기</span>';
            star.onclick = (ev) => {
              ev.preventDefault();
              ev.stopPropagation();
              if (state.favs.has(p.href)) state.favs.delete(p.href);
              else state.favs.add(p.href);
              const r = await saveRepoFavs(state.favs);
              if (!r.ok) console.warn('favorites sync failed; fell back to local', r.error);
              render();
            };

            top.appendChild(h2);
            top.appendChild(star);

            const desc = document.createElement('p');
            desc.textContent = p.description || '';
            const meta = document.createElement('div');
            meta.className = 'meta';
            meta.textContent = `${p.category || ''} · ${p.date || ''} · ${p.id || ''}`;

            card.appendChild(top);
            card.appendChild(desc);
            card.appendChild(meta);
            grid.appendChild(card);
          }
        }

        render();
      }
      boot();
    </script>
  </main>
</body>
</html>
